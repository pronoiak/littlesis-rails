<%
# layout helpers
label_class = 'col-form-label'

date_text = {
  'start' => { 'Org' => 'Start date:', 'Person' => 'Birth date' },
  'end' => { 'Org' => 'End date:', 'Person' => 'Death date' }
}

is_current_text = {
  'Org' => 'Is current?',
  'Person' => 'Alive?'
}

%>

<% content_for(:page_title, 'Edit: ' + @entity.name ) %>

<%= render partial: 'header', locals: { entity: @entity } %>
<%= render partial: 'actions', locals: { entity: @entity } %>

<%= form_for @entity, method: 'patch', class: 'form-horizontal', builder: LsFormBuilder, data: {controller: "entity-edit"} do |f| %>

  <div class="row mb-2 mt-2">
    <div class="col-sm-12 col-md-6">
      <%= render partial: 'shared/editing/reference_widget',
                 locals: { documents: RecentEntityReferencesQuery.run(@entity) } %>
    </div>

    <div class="col-sm-12 col-md-5 col-md-offset-1">
      <%= render partial: 'edit_errors' %>
    </div>
  </div>

  <% if @entity.person? %>
    <%= render partial: 'type_checkboxes_person', locals: { f: f } %>
  <% else  %>
    <%= render partial: 'type_checkboxes_org', locals: { f: f } %>
  <% end  %>

  <%= edit_entity_form_section(
    f.label(:blurb, 'Short Description', class: label_class),
    f.text_field(:blurb, class: 'form-control')
  ) %>

  <%= edit_entity_form_section(
    f.label(:summary, 'Summary:', class: label_class),
    f.text_area(:summary, class: 'form-control', size: '40x6')
  ) %>

  <%= edit_entity_form_section(
    f.label(:start_date, date_text.dig('start', @entity.primary_ext), class: label_class),
    f.text_field(:start_date) # + content_tag(:small, '(YYYY-MM-DD. Use 1968-05-00 to specify May 1968)')
  ) %>

  <%= edit_entity_form_section(
    f.label(:end_date, date_text.dig('end', @entity.primary_ext), class: label_class),
    f.text_field(:end_date) # + content_tag(:small, '(YYYY-MM-DD. Use 1968-05-00 to specify May 1968)')
  ) %>



  <%= edit_entity_form_section(
    f.label(:is_current, is_current_text[@entity.primary_ext], class: label_class),
    f.tri_boolean(:is_current)
  ) %>

  <%= edit_entity_form_section(
    f.label(:website, "Website:", class: label_class),
    f.url_field(:website)
  ) %>

  <% if @entity.person?  %>
    <%= f.fields_for :person do |person_form| %>
      <% %i[name_first name_middle name_last name_prefix name_suffix name_nick birthplace].each do |attribute| %>
        <%= edit_entity_form_section(
          person_form.label(attribute, Person::DISPLAY_ATTRIBUTES[attribute], class: label_class),
          person_form.text_field(attribute)
        ) %>
      <% end %>
      <%= edit_entity_form_section(
        person_form.label(:gender, "Gender:", class: label_class),
        person_form.select(:gender_id, gender_select_options(person_form))
      ) %>
    <% end %>
  <% end %>

  <% if @entity.has_extension?('PublicCompany') %>
    <%= f.fields_for :public_company do |public_company_form| %>
      <%= edit_entity_form_section(
        public_company_form.label(:ticker, 'Ticker', class: label_class),
        public_company_form.text_field(:ticker)
      ) %>
    <% end %>
  <% end %>

  <% if @entity.has_extension?('Business') %>
    <%= f.fields_for :business do |business_form| %>
      <%= edit_entity_form_section(
        business_form.label(:marketcap, 'Market capitalization', class: label_class),
        business_form.number_field(:marketcap)
      ) %>
      <%= edit_entity_form_section(
        business_form.label(:assets, 'Assets', class: label_class),
        business_form.number_field(:assets)
      ) %>
      <%= edit_entity_form_section(
        business_form.label(:net_income, 'Net income', class: label_class),
        business_form.number_field(:net_income)
      ) %>
      <%= edit_entity_form_section(
        business_form.label(:annual_profit, 'Annual profit', class: label_class),
        business_form.number_field(:annual_profit)
      ) %>
    <% end %>
  <% end %>

  <% if @entity.has_extension?('School') %>
    <%= f.fields_for :school, @entity.school do |school_form| %>
      <%= edit_entity_form_section(
        school_form.label(:is_private, 'Private School?', class: label_class),
        school_form.tri_boolean(:is_private)
      ) %>
    <% end %>
  <% end %>

  <%# Regions %>
  <%= edit_entity_form_section(
    f.label(:regions, 'Location: ', class: label_class),
    f.select(:regions,
             options_for_select(Location.regions.to_a, selected: @entity.region_numbers),
             { include_blank: true},
             { multiple: true })
  ) %>

  <div class="row mb-3">
    <div class="col-8">
      <%= f.submit 'Update', class: 'btn btn-primary' %>
      <%= link_to 'Cancel', @entity.url, class: 'btn btn-secondary ms-2' %>
    </div>
  </div>
<% end  # end form-for %>

<hr>

<%= render partial: 'edit_aliases' %>
<hr>
<%= render partial: 'edit_external_links' %>
